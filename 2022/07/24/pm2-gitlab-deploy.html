<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Deploying to VM using pm2 deploy via gitlab ci</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Deploying to VM using pm2 deploy via gitlab ci" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I host some of my work code repository on gitlab, and often deploy builds to a virtual machine manually. To reduce the effort and mental overhead of deployment, I eventually figured out how to setup automatic deployment from selected branch into selected environment on push." />
<meta property="og:description" content="I host some of my work code repository on gitlab, and often deploy builds to a virtual machine manually. To reduce the effort and mental overhead of deployment, I eventually figured out how to setup automatic deployment from selected branch into selected environment on push." />
<link rel="canonical" href="https://cwkang1998.github.io/2022/07/24/pm2-gitlab-deploy.html" />
<meta property="og:url" content="https://cwkang1998.github.io/2022/07/24/pm2-gitlab-deploy.html" />
<meta property="og:site_name" content="cwkâ€™s digital garden" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-24T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Deploying to VM using pm2 deploy via gitlab ci" />
<script type="application/ld+json">
{"description":"I host some of my work code repository on gitlab, and often deploy builds to a virtual machine manually. To reduce the effort and mental overhead of deployment, I eventually figured out how to setup automatic deployment from selected branch into selected environment on push.","@type":"BlogPosting","headline":"Deploying to VM using pm2 deploy via gitlab ci","dateModified":"2022-07-24T00:00:00+00:00","datePublished":"2022-07-24T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://cwkang1998.github.io/2022/07/24/pm2-gitlab-deploy.html"},"url":"https://cwkang1998.github.io/2022/07/24/pm2-gitlab-deploy.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://cwkang1998.github.io/feed.xml" title="cwk's digital garden" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a><article>
  <p class="post-meta">
    <time datetime="2022-07-24 00:00:00 +0000">2022-07-24</time>
  </p>
  
  <h1>Deploying to VM using pm2 deploy via gitlab ci</h1>

  <p>I host some of my work code repository on gitlab, and often deploy builds to a virtual machine manually. To reduce the effort and mental overhead of deployment, I eventually figured out how to setup automatic deployment from selected branch into selected environment on push.</p>

<h2 id="background">Background</h2>

<p>Since I work with Javascript and Typescript quite a lot, <code class="language-plaintext highlighter-rouge">pm2</code> became the go to process manager for me. When working with it, I discovered that it provided a handy <code class="language-plaintext highlighter-rouge">pm2 deploy</code> command for use, which I then decide to leverage.</p>

<p>The behavior I wanted was simple; On push to specific branch, gitlab should deploy the newest changes to the targeted machine and environment, e.g. If I push some changes to the <code class="language-plaintext highlighter-rouge">staging</code> branch, I expect the newest changes to be pushed to the target vm <code class="language-plaintext highlighter-rouge">staging</code> environment.</p>

<p>This is how I came up with what I have here, a simple and straight forward method that does not require additional software to be installed in addition to what was already used. Note that this method does not employ the use of a self hosted <code class="language-plaintext highlighter-rouge">gitlab-runner</code>, and as such may have caveats to it that does not fit your use case, such as security and workload concerns. Please do your research before using in wide spread production.</p>

<h2 id="ecosystemconfigjs-setup"><code class="language-plaintext highlighter-rouge">ecosystem.config.js</code> setup</h2>

<p>A simple setup for <code class="language-plaintext highlighter-rouge">ecosystem.config.js</code> was first required to get this working.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">DEPLOY_MACHINE</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">my-service</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">script</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/index.js</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">instances</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">exec_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">cluster</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">env_production</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">PORT</span><span class="p">:</span> <span class="dl">'</span><span class="s1">38965</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="na">env_staging</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">'</span><span class="s1">staging</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">PORT</span><span class="p">:</span> <span class="dl">'</span><span class="s1">38966</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">],</span>

  <span class="na">deploy</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">production</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">vm_user</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">DEPLOY_MACHINE</span><span class="p">,</span>
      <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">origin/main</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">repo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">git@gitlab.com:my-org/my-service.git</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/home/vm_user/production/my-service</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">post-deploy</span><span class="dl">'</span><span class="p">:</span>
        <span class="dl">'</span><span class="s1">nvm use 14 &amp;&amp; npm i &amp;&amp; PM2_HOME=/home/vm_user/.pm2 pm2 startOrRestart ecosystem.config.js --env production</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">staging</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">vm_user</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">DEPLOY_MACHINE</span><span class="p">,</span>
      <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">origin/staging</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">repo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">git@gitlab.com:my-org/my-service.git</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/home/vm_user/staging/my-service</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">post-deploy</span><span class="dl">'</span><span class="p">:</span>
        <span class="dl">'</span><span class="s1">nvm use 14 &amp;&amp; npm i &amp;&amp; PM2_HOME=/home/vm_user/.pm2 pm2 startOrRestart ecosystem.config.js --env staging</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Remember to add the <code class="language-plaintext highlighter-rouge">DEPLOY_MACHINE</code> (IP address for your target deployment machine) into your gitlab repository CI/CD environmental variables (should be at <code class="language-plaintext highlighter-rouge">Settings &gt; CI/CD &gt; Variables</code>).</p>

<h2 id="setting-up-gitlab-ciyml">Setting up <code class="language-plaintext highlighter-rouge">gitlab-ci.yml</code></h2>

<p>As pm2 uses a ssh connection we have to setup a public private key pair for ssh use. This can be done using the <code class="language-plaintext highlighter-rouge">ssh-keygen</code> utility. The public key</p>

<p>In the end, the <code class="language-plaintext highlighter-rouge">gitlab-ci.yml</code> should look something like this.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">default</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">node:16</span>

<span class="c1"># Deployment to production for the production branch</span>
<span class="na">deploy-production</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apt-get install git openssh-client -y</span>
    <span class="pi">-</span> <span class="s">eval $(ssh-agent -s)</span>
    <span class="pi">-</span> <span class="s">ssh-add &lt;(echo "$SSH_PRIVATE_KEY")</span>
    <span class="pi">-</span> <span class="s">mkdir -p ~/.ssh</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">[[</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">/.dockerenv</span><span class="nv"> </span><span class="s">]]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">"Host</span><span class="nv"> </span><span class="s">*\n\tStrictHostKeyChecking</span><span class="nv"> </span><span class="s">no\n\n"</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">~/.ssh/config'</span>
    <span class="pi">-</span> <span class="s">npx pm2 deploy ecosystem.config.js production setup --force 2&gt;&amp;1 || </span><span class="no">true</span>
    <span class="pi">-</span> <span class="s">npx pm2 deploy ecosystem.config.js production --force</span> 
  <span class="na">only</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">main</span>

<span class="c1"># Deployment to staging for the staging branch</span>
<span class="na">deploy-staging</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">apt-get install git openssh-client -y</span>
    <span class="pi">-</span> <span class="s">eval $(ssh-agent -s)</span>
    <span class="pi">-</span> <span class="s">ssh-add &lt;(echo "$SSH_PRIVATE_KEY")</span>
    <span class="pi">-</span> <span class="s">mkdir -p ~/.ssh</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">[[</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">/.dockerenv</span><span class="nv"> </span><span class="s">]]</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">"Host</span><span class="nv"> </span><span class="s">*\n\tStrictHostKeyChecking</span><span class="nv"> </span><span class="s">no\n\n"</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">~/.ssh/config'</span>
    <span class="pi">-</span> <span class="s">npx pm2 deploy ecosystem.config.js staging setup --force 2&gt;&amp;1 || </span><span class="no">true</span>
    <span class="pi">-</span> <span class="s">npx pm2 deploy ecosystem.config.js staging --force</span> 
  <span class="na">only</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">staging</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">SSH_PRIVATE_KEY</code> variables should be added into your gitlab repository CI/CD environmental variables (should be at <code class="language-plaintext highlighter-rouge">Settings &gt; CI/CD &gt; Variables</code>).</p>

<h2 id="setup-your-deploy_machine">Setup your <code class="language-plaintext highlighter-rouge">DEPLOY_MACHINE</code></h2>

<p>The final step consists of only 2 steps and will get everything working together.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">ssh</code> into your target deployment machine and add the public key corresponding to the <code class="language-plaintext highlighter-rouge">SSH_PRIVATE_KEY</code> youâ€™ve generated for this purpose into the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file in <code class="language-plaintext highlighter-rouge">~/.ssh</code> (from <a href="#setting-up-gitlab-ciyml">here</a>).</li>
  <li>Generate another public private key pair on your deployment machine and add the public key as a deploy key on your gitlab repository (should be at <code class="language-plaintext highlighter-rouge">Settings &gt; Repository &gt; Deploy Key</code>).</li>
</ol>

<p>Note 2 key pairs should exists at this point, one to allow <code class="language-plaintext highlighter-rouge">pm2</code> to deploy from gitlab ci to your target deployment machine, another to allow your target deployment machine to <code class="language-plaintext highlighter-rouge">git pull</code> your new changes down from gitlab.</p>

<p>With this setup, gitlab ci should automatically deploy your branch to your target machine after any new changes is pushed and your pipeline succeeds.</p>

<h2 id="troubleshooting-public-key-failed-authentication">Troubleshooting public key failed authentication</h2>

<p>There might be multiple reasons that the CI/CD process fails to authenticate with the target deployment machine:</p>

<ol>
  <li>Lack of any 1 of the 2 required key pairs. See <a href="#setup-your-deploy_machine">previous section</a>.</li>
  <li>Incorrect key pairs</li>
  <li>Unable to authenticate due to different naming for key store file from default. <code class="language-plaintext highlighter-rouge">id_rsa</code> is usually where <code class="language-plaintext highlighter-rouge">sshd</code> would try to locate the keys, but it might nto find it due to your provided naming. As such we will need to add a <code class="language-plaintext highlighter-rouge">config</code> file in <code class="language-plaintext highlighter-rouge">~/.ssh</code> to indicate which keys belong to who. An example:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host gitlab.com
 HostName gitlab.com
 User git
 AddKeysToAgent <span class="nb">yes
 </span>IdentityFile ~/.ssh/gitlab_access
</code></pre></div></div>

<h2 id="deploying-multiple-apps-onto-one-machine">Deploying multiple apps onto one machine</h2>

<p>Sometimes you might need to deploy multiple apps onto one machine, and in that case you might get an error on gitlab if you attempt to add the same deploy key for different apps. Even when you add another key on your target machine and add it as a deploy key, it will fail. In this case, you will need to update your ssh <code class="language-plaintext highlighter-rouge">config</code> and <code class="language-plaintext highlighter-rouge">pm2</code>â€™s <code class="language-plaintext highlighter-rouge">ecosystem.config.js</code> to account for this change.</p>

<p>An example:</p>

<h3 id="ssh-config">ssh <code class="language-plaintext highlighter-rouge">config</code></h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># App 1 deploy key</span>
Host gitlab.com-app1
 HostName gitlab.com
 User git
 AddKeysToAgent <span class="nb">yes
 </span>IdentityFile ~/.ssh/gitlab_access_app1
<span class="c"># Work GitHub account</span>
Host gitlab.com-app2
 HostName gitlab.com
 User git
 AddKeysToAgent <span class="nb">yes
 </span>IdentityFile ~/.ssh/gitlab_access_app2
</code></pre></div></div>

<h3 id="app-1-ecosystemconfigjs">App 1 <code class="language-plaintext highlighter-rouge">ecosystem.config.js</code></h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">DEPLOY_MACHINE</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">script</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/index.js</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">instances</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">exec_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">cluster</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">env_production</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">PORT</span><span class="p">:</span> <span class="dl">'</span><span class="s1">38965</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">],</span>

  <span class="na">deploy</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">production</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">vm_user</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">DEPLOY_MACHINE</span><span class="p">,</span>
      <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">origin/main</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">repo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">git@gitlab.com-app1:my-org/app1.git</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Use gitlab.com-app1 here</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/home/vm_user/production/app1</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">post-deploy</span><span class="dl">'</span><span class="p">:</span>
        <span class="dl">'</span><span class="s1">nvm use 14 &amp;&amp; npm i &amp;&amp; PM2_HOME=/home/vm_user/.pm2 pm2 startOrRestart ecosystem.config.js --env production</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="app-2-ecosystemconfigjs">App 2 <code class="language-plaintext highlighter-rouge">ecosystem.config.js</code></h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">DEPLOY_MACHINE</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app2</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">script</span><span class="p">:</span> <span class="dl">'</span><span class="s1">src/index.js</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">instances</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">exec_mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">cluster</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">env_production</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">PORT</span><span class="p">:</span> <span class="dl">'</span><span class="s1">38965</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">],</span>

  <span class="na">deploy</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">production</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">user</span><span class="p">:</span> <span class="dl">'</span><span class="s1">vm_user</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">DEPLOY_MACHINE</span><span class="p">,</span>
      <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">origin/main</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">repo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">git@gitlab.com-app2:my-org/app2.git</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Use gitlab.com-app2 here</span>
      <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/home/vm_user/production/app2</span><span class="dl">'</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">post-deploy</span><span class="dl">'</span><span class="p">:</span>
        <span class="dl">'</span><span class="s1">nvm use 14 &amp;&amp; npm i &amp;&amp; PM2_HOME=/home/vm_user/.pm2 pm2 startOrRestart ecosystem.config.js --env production</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

</article>
      </div>
    </main>
  </body>
</html>